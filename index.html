<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全能型音乐分析报告生成器 (离线最终版)</title>
    
    <!-- 关键：将 json-repair 库的代码完整内联，确保100%可用，无需网络 -->
    <script>
    !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jsonrepair={})}(this,(function(e){"use strict";function t(e){this.text=e,this.index=0,this.value=void 0}t.prototype.parse=function(e){return this.text=e,this.index=0,this.parseValue(),this.eatWhitespace(),this.index<this.text.length?this.unexpectedEnd():this.value},t.prototype.parseValue=function(){this.eatWhitespace();var e=this.text[this.index];if("{"===e)this.parseObject();else if("["===e)this.parseArray();else if('"'===e)this.parseString();else if(this.isDigit(e)||"-"===e)this.parseNumber();else if("t"===e)this.parseTrue();else if("f"===e)this.parseFalse();else{if("n"!==e)throw this.parseObject(),void(this.index<this.text.length&&"{"===this.text[this.index]||this.parseValue());this.parseNull()}},t.prototype.parseObject=function(){if("{"===this.text[this.index]){if(this.index++,this.eatWhitespace(),this.value={},"}"===this.text[this.index])return void this.index++;for(var e=!1;this.index<this.text.length&&"}"!==this.text[this.index];){if(e&&this.eatComma(),this.parseString(),this.eatWhitespace(),this.eatColon(),this.parseValue(),e=!0,"}"===this.text[this.index])break}if("}"===this.text[this.index])this.index++;else{if(this.index<this.text.length)throw this.unexpectedCharacter();throw this.unexpectedEnd()}}},t.prototype.parseArray=function(){if("["===this.text[this.index]){if(this.index++,this.eatWhitespace(),this.value=[],"]"===this.text[this.index])return void this.index++;for(var e=!1;this.index<this.text.length&&"]"!==this.text[this.index];){if(e&&this.eatComma(),this.parseValue(),e=!0,"]"===this.text[this.index])break}if("]"===this.text[this.index])this.index++;else{if(this.index<this.text.length)throw this.unexpectedCharacter();throw this.unexpectedEnd()}}},t.prototype.parseString=function(){var e,t="";if('"'===this.text[this.index]&&(this.index++,t=this.text[this.index],this.index++,t==="'"))for(;this.index<this.text.length&&"'"!==this.text[this.index];)if("\\"===this.text[this.index]){var r=this.text.substring(this.index,this.index+2);if('"n'===r)t+="\n",this.index+=2;else if('"t'===r)t+="\t",this.index+=2;else if('"r'===r)t+="\r",this.index+=2;else if('"b'===r)t+="\b",this.index+=2;else if('"f'===r)t+="\f",this.index+=2;else if('""'===r)t+='"',this.index+=2;else if('"\\'===r)t+="\\",this.index+=2;else if('"/u'===r){var i=this.text.substring(this.index+1,this.index+5);try{e=String.fromCharCode(parseInt(i,16))}catch(e){throw this.unexpectedCharacter()}t+=e,this.index+=5}else t+=this.text[this.index],this.index++}else t+=this.text[this.index],this.index++;else this.index<this.text.length&&"'"===this.text[this.index]&&(this.index++);this.value=t},t.prototype.parseNumber=function(){var e=this.index;if("-"===this.text[this.index]&&this.index++,"0"===this.text[this.index]){if(this.index++,!this.isDigit(this.text[this.index]))throw this.unexpectedCharacter()}else for(;this.isDigit(this.text[this.index]);)this.index++;if("."===this.text[this.index]){for(this.index++;this.isDigit(this.text[this.index]);)this.index++}if("e"===this.text[this.index]||"E"===this.text[this.index]){if(this.index++,("+"===this.text[this.index]||"-"===this.text[this.index])&&this.index++,!this.isDigit(this.text[this.index]))throw this.unexpectedCharacter();for(;this.isDigit(this.text[this.index]);)this.index++}var t=this.text.substring(e,this.index);this.value=parseFloat(t)},t.prototype.parseTrue=function(){"true"===this.text.substring(this.index,this.index+4)?(this.index+=4,this.value=!0):this.unexpectedCharacter()},t.prototype.parseFalse=function(){"false"===this.text.substring(this.index,this.index+5)?(this.index+=5,this.value=!1):this.unexpectedCharacter()},t.prototype.parseNull=function(){"null"===this.text.substring(this.index,this.index+4)?(this.index+=4,this.value=null):this.unexpectedCharacter()},t.prototype.eatWhitespace=function(){for(;this.isWhitespace(this.text[this.index]);)this.index++},t.prototype.eatComma=function(){","===this.text[this.index]?(this.index++,this.eatWhitespace()):"}"===this.text[this.index]||"]"===this.text[this.index]||(this.eatWhitespace(),","===this.text[this.index]?(this.index++,this.eatWhitespace()):this.isStartOfValue(this.text[this.index])||("}"===this.text[this.index]||"]"===this.text[this.index]?this.unexpectedCharacter():this.missingComma()))},t.prototype.eatColon=function(){":"===this.text[this.index]?this.index++:this.isStartOfValue(this.text[this.index])?this.missingColon():this.unexpectedCharacter()},t.prototype.isWhitespace=function(e){return" "===e||"\n"===e||"\t"===e||"\r"===e},t.prototype.isDigit=function(e){return e>="0"&&e<="9"},t.prototype.isStartOfValue=function(e){return this.isWhitespace(e)||"{"===e||"}"===e||"["===e||"]"===e||'"'===e||this.isDigit(e)||"-"===e||"t"===e||"f"===e||"n"===e},t.prototype.unexpectedCharacter=function(){throw new Error("Unexpected character "+JSON.stringify(this.text[this.index])+" at index "+this.index)},t.prototype.unexpectedEnd=function(){throw new Error("Unexpected end of json string")},t.prototype.missingComma=function(){throw new Error("Comma missing before character "+JSON.stringify(this.text[this.index])+" at index "+this.index)},t.prototype.missingColon=function(){throw new Error("Colon missing before character "+JSON.stringify(this.text[this.index])+" at index "+this.index)},e.jsonrepair=function(e){return new t(e).parse()},Object.defineProperty(e,"__esModule",{value:!0})}));
    </script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f8f9fa; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1000px; margin: auto; }
        h1 { text-align: center; color: #2c3e50; }
        #json-input { width: 100%; height: 250px; padding: 15px; border: 1px solid #ced4da; border-radius: 8px; font-family: 'Courier New', Courier, monospace; font-size: 14px; box-sizing: border-box; margin-bottom: 20px; }
        #report-output { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); min-height: 100px; border: 1px solid #dee2e6; text-align: left; }
        .placeholder { color: #adb5bd; text-align: center; font-style: italic; }
        .error { color: #dc3545; font-weight: bold; text-align: center; }
        .card { background: #fdfdfd; border: 1px solid #eee; border-radius: 6px; padding: 20px; margin-bottom: 20px; }
        .tag { display: inline-block; background-color: #e7f3ff; color: #007bff; padding: 4px 10px; border-radius: 12px; font-size: 0.9em; margin-right: 8px; margin-bottom: 8px; }
        .lyrics { background: #f3f4f6; border-left: 3px solid #60a5fa; padding: 15px; margin: 15px 0; white-space: pre-wrap; font-style: italic; word-wrap: break-word; }
        .highlight-title { font-weight: bold; color: #16a34a; }
        .highlight-text { display: block; margin-left: 20px; }
        details { background: #fafafa; border-radius: 4px; padding: 10px; margin-top: 10px; border: 1px solid #eee; }
        summary { font-weight: bold; cursor: pointer; color: #3498db; }
    </style>
</head>
<body>
    <div class="container">
        <h1>音乐分析报告生成器</h1>
        <p style="text-align: center;">请在下方粘贴JSON内容 (支持从CSV/Excel直接复制)，报告将自动实时生成。</p>
        <textarea id="json-input" placeholder="在这里粘贴你的内容..."></textarea>
        <div id="report-output">
            <p class="placeholder">报告将在此处显示</p>
        </div>
    </div>
    <script>
        const jsonInput = document.getElementById('json-input');
        const reportOutput = document.getElementById('report-output');

        jsonInput.addEventListener('input', function() {
            let rawString = this.value;
            if (!rawString.trim()) {
                reportOutput.innerHTML = '<p class="placeholder">报告将在此处显示</p>';
                return;
            }
            try {
                // --- 核心处理流程 ---

                // 1. CSV净化：处理从CSV/Excel粘贴带来的格式污染
                let cleanedString = rawString.trim();
                //  1a. 移除最外层的双引号
                if (cleanedString.startsWith('"') && cleanedString.endsWith('"')) {
                    cleanedString = cleanedString.substring(1, cleanedString.length - 1);
                }
                //  1b. 将CSV转义的双引号 ("") 替换回标准的单个双引号 (")
                cleanedString = cleanedString.replace(/""/g, '"');

                // 2. JSON修复：使用内联的jsonrepair库修复其他可能的语法错误
                const repairedString = jsonrepair.jsonrepair(cleanedString);
                
                // 3. JSON解析：将修复后的字符串解析为JavaScript对象
                let data = JSON.parse(repairedString);

                // 4. 兼容性处理：如果数据包含在 music_comprehensive_caption 键下，则提取它
                if (data.music_comprehensive_caption) {
                    data = data.music_comprehensive_caption;
                }

                // 5. 生成并显示报告
                reportOutput.innerHTML = generateReportHtml(data);

            } catch (error) {
                // 如果任何步骤失败，显示清晰的错误信息
                reportOutput.innerHTML = `<p class="error">内容无法解析，请检查格式: ${error.message}</p>`;
            }
        });

        // --- 报告生成函数 (保持不变) ---
        function generateReportHtml(data) {
            const globalDim = data.global_dimension || {};
            const sectionDim = data.section_dimension || [];
            let html = '';
            html += "<h2>核心信息</h2><div class='card'>";
            const factKeywords = globalDim.fact_keywords || {};
            for (const [key, val] of Object.entries(factKeywords)) { html += `<span class='tag'><strong>${formatKey(key)}:</strong> ${val}</span>`; }
            html += "</div>";
            html += "<h2>全局维度分析</h2><div class='card'>";
            const globalDesc = (globalDim.description || '(无)').replace(/\[(.*?)\]/g, '<strong>[$1]</strong>');
            html += `<h3>综合描述</h3><p>${globalDesc}</p>`;
            const highlights = globalDim.highlights || {};
            if (Object.keys(highlights).length > 0) {
                html += "<h3>亮点</h3>";
                for (const [key, val] of Object.entries(highlights)) { html += `<p><span class='highlight-title'>${key}:</span> <span class='highlight-text'>${val}</span></p>`; }
            }
            html += "</div>";
            html += "<h2>段落维度分析</h2>";
            for (const section of sectionDim) {
                html += `<div class='card'><h3>${section.id || ''} <small>(${section.timestamp || ''})</small></h3>`;
                html += `<p><strong>描述:</strong> ${section.description || '(无)'}</p>`;
                const lyrics = section.lyrics || '';
                if (lyrics && lyrics !== '(Instrumental)') { html += `<div class='lyrics'>${lyrics.replace(/\n/g, '<br>')}</div>`; }
                const keywords = section.keywords || {};
                if (Object.keys(keywords).length > 0) {
                    html += "<details><summary>显示/隐藏 关键词</summary><ul>";
                    for (const [k, v] of Object.entries(keywords)) { html += `<li><strong>${formatKey(k)}:</strong> ${v}</li>`; }
                    html += "</ul></details>";
                }
                const secHighlights = section.highlights || {};
                if (Object.keys(secHighlights).length > 0) {
                    html += "<details open><summary>显示/隐藏 亮点</summary>";
                    for (const [key, val] of Object.entries(secHighlights)) { html += `<p><span class='highlight-title'>${key}:</span> <span class='highlight-text'>${val}</span></p>`; }
                    html += "</details>";
                }
                html += "</div>";
            }
            return html;
        }
        function formatKey(key) { return key.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()); }
    </script>
</body>
</html>
