<script>
    // 获取DOM元素
    const jsonInput = document.getElementById('json-input');
    const reportOutput = document.getElementById('report-output');

    // 监听输入框的实时变化
    jsonInput.addEventListener('input', function() {
        const jsonString = this.value.trim();

        // 如果输入为空，则显示占位符
        if (!jsonString) {
            reportOutput.innerHTML = '<p class="placeholder">报告将在此处显示</p>';
            return;
        }

        try {
            // --- 核心修改部分 ---
            let data = JSON.parse(jsonString);

            // **新增逻辑**：检查解析后的结果是否仍然是一个字符串。
            // 如果是，说明原始输入是“字符串化的JSON”，需要再解析一次。
            if (typeof data === 'string') {
                data = JSON.parse(data);
            }
            // --- 修改结束 ---

            // 检查是否存在 music_comprehensive_caption 键，如果存在则使用其内部数据
            // (这个逻辑在新格式下不再需要，因为新格式直接就是内容，但保留它可以兼容旧格式)
            if (data.music_comprehensive_caption) {
                data = data.music_comprehensive_caption;
            }

            // 生成HTML报告内容
            const reportHtml = generateReportHtml(data);
            reportOutput.innerHTML = reportHtml;

        } catch (error) {
            // 如果JSON格式错误，则显示错误信息
            reportOutput.innerHTML = `<p class="error">JSON格式或结构错误: ${error.message}</p>`;
        }
    });

    // 主函数：将解析后的JSON对象转换为HTML字符串 (这部分无需修改)
    function generateReportHtml(data) {
        const globalDim = data.global_dimension || {};
        const sectionDim = data.section_dimension || [];
        let html = '';

        // --- 核心信息 ---
        html += "<h2>核心信息</h2><div class='card'>";
        const factKeywords = globalDim.fact_keywords || {};
        for (const [key, val] of Object.entries(factKeywords)) {
            html += `<span class='tag'><strong>${formatKey(key)}:</strong> ${val}</span>`;
        }
        html += "</div>";

        // --- 全局维度 ---
        html += "<h2>全局维度分析</h2><div class='card'>";
        const globalDesc = (globalDim.description || '(无)').replace(/\[(.*?)\]/g, '<strong>[$1]</strong>');
        html += `<h3>综合描述</h3><p>${globalDesc}</p>`;
        
        const highlights = globalDim.highlights || {};
        if (Object.keys(highlights).length > 0) {
            html += "<h3>亮点</h3>";
            for (const [key, val] of Object.entries(highlights)) {
                html += `<p><span class='highlight-title'>${key}:</span> <span class='highlight-text'>${val}</span></p>`;
            }
        }
        html += "</div>";

        // --- 段落维度 ---
        html += "<h2>段落维度分析</h2>";
        for (const section of sectionDim) {
            html += `<div class='card'><h3>${section.id || ''} <small>(${section.timestamp || ''})</small></h3>`;
            html += `<p><strong>描述:</strong> ${section.description || '(无)'}</p>`;
            
            const lyrics = section.lyrics || '';
            if (lyrics && lyrics !== '(Instrumental)') {
                // 将歌词中的 \n 替换为 <br> 以便在HTML中正确换行
                html += `<div class='lyrics'>${lyrics.replace(/\n/g, '<br>')}</div>`;
            }

            const keywords = section.keywords || {};
            if (Object.keys(keywords).length > 0) {
                html += "<details><summary>显示/隐藏 关键词</summary><ul>";
                for (const [k, v] of Object.entries(keywords)) {
                    html += `<li><strong>${formatKey(k)}:</strong> ${v}</li>`;
                }
                html += "</ul></details>";
            }
            
            const secHighlights = section.highlights || {};
            if (Object.keys(secHighlights).length > 0) {
                html += "<details open><summary>显示/隐藏 亮点</summary>";
                for (const [key, val] of Object.entries(secHighlights)) {
                    html += `<p><span class='highlight-title'>${key}:</span> <span class='highlight-text'>${val}</span></p>`;
                }
                html += "</details>";
            }
            html += "</div>";
        }
        return html;
    }

    // 辅助函数：格式化key（例如 "chord_progression" -> "Chord Progression"） (这部分无需修改)
    function formatKey(key) {
        return key.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
    }
</script>
